<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caregiver Dashboard ‚Äì AfterHeal</title>
    <meta name="description" content="Monitor patient adherence, view missed dose alerts, and log caregiver support.">
    <link rel="stylesheet" href="styles/global.css">
    <link rel="stylesheet" href="styles/dashboard.css">
    <style>
        /* Non-dismissible caregiver alert banner */
        .cg-alert-banner {
            display: none;
            align-items: flex-start;
            gap: 16px;
            background: linear-gradient(135deg, #FFF0F0, #FFF8F8);
            border: 2px solid var(--poor);
            border-radius: var(--radius);
            padding: 16px 20px;
            margin: 16px 20px 0;
            color: #7D1A1A;
        }

        .cg-alert-banner .cg-banner-icon {
            font-size: 1.6rem;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .cg-alert-banner .cg-banner-body {
            flex: 1;
        }

        .cg-alert-banner .cg-banner-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
            flex-wrap: wrap;
        }

        .log-unack {
            border-left: 3px solid var(--poor);
        }

        .alert-log-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 14px 16px;
            margin-bottom: 10px;
        }
    </style>
</head>

<body class="theme-caregiver">
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <div class="dashboard-shell">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-logo">
                <div class="sidebar-logo-icon theme-caregiver"
                    style="background:rgba(108,92,231,0.15);color:var(--caregiver-color)">üè•</div>
                <div>
                    <div class="sidebar-logo-text">AfterHeal</div>
                    <div class="sidebar-logo-sub">Caregiver Portal</div>
                </div>
            </div>
            <div class="sidebar-user">
                <div class="sidebar-avatar" id="sidebar-avatar" style="background:var(--caregiver-color)">C</div>
                <div>
                    <div class="sidebar-user-name" id="sidebar-user-name">Caregiver</div>
                    <div class="sidebar-user-role" id="sidebar-user-role">caregiver</div>
                </div>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-group-label">Care Management</div>
                <button class="nav-link active" data-section="section-overview">
                    <span class="nav-icon">üè†</span> Overview
                </button>
                <button class="nav-link" data-section="section-patients">
                    <span class="nav-icon">üë§</span> Patient Overview
                </button>
                <button class="nav-link" data-section="section-alerts">
                    <span class="nav-icon">üîî</span> Missed Dose Alerts
                    <span class="nav-badge" id="nav-alert-badge"></span>
                </button>
                <button class="nav-link" data-section="section-my-alerts">
                    <span class="nav-icon">üö®</span> My Received Alerts
                    <span class="nav-badge" id="cg-alert-badge" style="background:var(--poor)"></span>
                </button>
                <button class="nav-link" data-section="section-log">
                    <span class="nav-icon">üìù</span> Support Log
                </button>
            </nav>
            <div class="sidebar-footer">
                <button class="logout-btn"><span>üö™</span> Logout</button>
            </div>
        </aside>

        <!-- Main -->
        <div class="main-content">
            <header class="topbar">
                <div class="topbar-left">
                    <button class="hamburger-btn" id="hamburger-btn">‚ò∞</button>
                    <div>
                        <div class="topbar-title" id="topbar-greeting">Welcome üëã</div>
                        <div class="topbar-subtitle">Caregiver Dashboard</div>
                    </div>
                </div>
                <div class="topbar-right">
                    <div class="topbar-date" id="topbar-date"></div>
                    <button class="btn btn-outline btn-sm logout-btn">Logout</button>
                </div>
            </header>

            <main class="page-content">

                <!-- ‚ö†Ô∏è NON-DISMISSIBLE CAREGIVER ALERT BANNER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                     This banner is shown whenever there are unacknowledged missed-dose
                     alert logs directed at this caregiver. It cannot be closed ‚Äî it
                     disappears only when the caregiver clicks "Acknowledge All".
                     This is critical for medical accountability.
                ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
                <div class="cg-alert-banner" id="cg-alert-banner">
                    <div class="cg-banner-icon">üö®</div>
                    <div class="cg-banner-body" id="cg-alert-banner-text">
                        <strong>‚ö†Ô∏è Unacknowledged Missed-Dose Alerts</strong>
                        <p style="font-size:0.85rem;margin-top:4px">You have patients with unacknowledged missed doses.
                            Please review and acknowledge.</p>
                    </div>
                    <div class="cg-banner-actions">
                        <button class="btn btn-danger btn-sm" onclick="acknowledgeAllCgLogs()">‚úì Acknowledge
                            All</button>
                        <button class="btn btn-outline btn-sm" style="border-color:var(--poor);color:var(--poor)"
                            onclick="document.querySelector('[data-section=section-my-alerts]').click()">
                            View Alerts
                        </button>
                    </div>
                </div>
                <!-- ‚îÄ‚îÄ Overview ‚îÄ‚îÄ -->
                <section class="dashboard-section" id="section-overview">
                    <div class="page-header">
                        <h2>Caregiver Overview</h2>
                        <p>Your care summary ‚Äî patients assigned, missed doses, and support activity.</p>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon stat-icon-purple">üë§</div>
                            <div class="stat-info">
                                <div class="stat-value" id="stat-assigned">0</div>
                                <div class="stat-label">Patients Assigned</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon stat-icon-orange">‚ö†Ô∏è</div>
                            <div class="stat-info">
                                <div class="stat-value" id="stat-missed-d">0</div>
                                <div class="stat-label">Total Missed Doses</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon stat-icon-green">üìä</div>
                            <div class="stat-info">
                                <div class="stat-value" id="stat-avg-adh">--%</div>
                                <div class="stat-label">Avg. Adherence</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon stat-icon-blue">üìù</div>
                            <div class="stat-info">
                                <div class="stat-value" id="stat-logs">0</div>
                                <div class="stat-label">Support Logs</div>
                            </div>
                        </div>
                    </div>

                    <!-- Alert preview -->
                    <div class="card-flat mb-16">
                        <div class="section-title">
                            <h3>‚ö†Ô∏è Recent Missed Doses</h3>
                            <button class="btn btn-outline btn-sm"
                                onclick="document.querySelector('[data-section=section-alerts]').click()">View
                                All</button>
                        </div>
                        <div id="alerts-preview"></div>
                    </div>

                    <!-- Quick Log -->
                    <div class="card-flat">
                        <h3 style="margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border)">üìù
                            Quick Support Note</h3>
                        <form id="quick-log-form" novalidate>
                            <div style="display:grid;grid-template-columns:1fr 2fr auto;gap:12px;align-items:end">
                                <div class="form-group" style="margin:0">
                                    <label class="form-label">Patient</label>
                                    <select id="quick-log-patient" class="form-control">
                                        <option value="">Select‚Ä¶</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin:0">
                                    <label class="form-label">Note</label>
                                    <input id="quick-log-note" type="text" class="form-control"
                                        placeholder="e.g. Assisted with morning medications‚Ä¶">
                                </div>
                                <button type="submit" class="btn btn-accent">Log</button>
                            </div>
                        </form>
                    </div>
                </section>

                <!-- ‚îÄ‚îÄ Patient Overview ‚îÄ‚îÄ -->
                <section class="dashboard-section" id="section-patients" style="display:none">
                    <div class="page-header">
                        <h2>Patient Overview</h2>
                        <p>Monitor assigned patients' medication schedules and adherence status.</p>
                    </div>
                    <div id="patient-overview">
                        <div class="empty-state">
                            <div class="empty-icon">üë§</div>
                            <p>Loading patients‚Ä¶</p>
                        </div>
                    </div>
                </section>

                <!-- ‚îÄ‚îÄ Missed Dose Alerts ‚îÄ‚îÄ -->
                <section class="dashboard-section" id="section-alerts" style="display:none">
                    <div class="page-header">
                        <h2>Missed Dose Alerts</h2>
                        <p>Real-time alerts for any overdue medications across your assigned patients.</p>
                    </div>
                    <div id="missed-alerts">
                        <div class="empty-state">
                            <div class="empty-icon">üîî</div>
                            <p>Loading alerts‚Ä¶</p>
                        </div>
                    </div>
                </section>

                <!-- ‚îÄ‚îÄ My Received Alerts (Caregiver Alert Log) ‚îÄ‚îÄ -->
                <section class="dashboard-section" id="section-my-alerts" style="display:none">
                    <div class="page-header">
                        <h2>üö® My Received Alerts</h2>
                        <p>All missed-dose alert notifications directed to you. Must be acknowledged for medical
                            accountability.</p>
                    </div>
                    <div style="display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap;align-items:center">
                        <button class="btn btn-danger" onclick="acknowledgeAllCgLogs()">‚úì Acknowledge All</button>
                        <span style="font-size:0.83rem;color:var(--text-muted)">
                            ‚ö†Ô∏è Unacknowledged alerts are shown in the red banner at the top of every page.
                        </span>
                    </div>
                    <div id="cg-alert-panel-list">
                        <div class="empty-state">
                            <div class="empty-icon">‚úÖ</div>
                            <p>No alerts received yet.</p>
                        </div>
                    </div>
                </section>

                <!-- ‚îÄ‚îÄ Support Log ‚îÄ‚îÄ -->
                <section class="dashboard-section" id="section-log" style="display:none">
                    <div class="page-header">
                        <h2>Support Log</h2>
                        <p>Record assistance provided and add notes for each patient interaction.</p>
                    </div>
                    <div class="form-panel mb-24">
                        <h3>üìù Add Support Note</h3>
                        <form id="log-form" novalidate>
                            <input type="hidden" id="log-patient-id">
                            <div class="form-group">
                                <label class="form-label">Patient</label>
                                <select id="log-select-patient" class="form-control">
                                    <option value="">Select patient‚Ä¶</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Support Note</label>
                                <input id="log-note" type="text" class="form-control"
                                    placeholder="Describe the assistance provided‚Ä¶" required>
                            </div>
                            <button type="submit" class="btn btn-accent">üìù Save Note</button>
                        </form>
                    </div>

                    <div class="section-title">
                        <h3>Log History</h3>
                    </div>
                    <div id="support-log">
                        <div class="empty-state">
                            <div class="empty-icon">üìã</div>
                            <p>No log entries yet.</p>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ Med Schedule Modal ‚îÄ‚îÄ -->
    <div class="modal-overlay" id="schedule-modal">
        <div class="modal" style="max-width:600px;max-height:90vh;overflow-y:auto">
            <div class="modal-header">
                <h3 id="schedule-modal-title">Medication Schedule</h3>
                <button class="modal-close" onclick="closeModal('schedule-modal')">‚úï</button>
            </div>
            <div id="schedule-content"></div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ Log Support Modal ‚îÄ‚îÄ -->
    <div class="modal-overlay" id="log-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>üìù Log Support for <span id="log-patient-name">Patient</span></h3>
                <button class="modal-close" onclick="closeModal('log-modal')">‚úï</button>
            </div>
            <form id="log-form-modal" novalidate>
                <div class="form-group">
                    <label class="form-label">Support Note</label>
                    <input id="log-note" type="text" class="form-control" placeholder="e.g. Assisted with medications‚Ä¶"
                        required>
                </div>
                <div style="display:flex;gap:10px">
                    <button type="submit" class="btn btn-accent flex-1">Save Note</button>
                    <button type="button" class="btn btn-ghost" onclick="closeModal('log-modal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script src="scripts/auth.js"></script>
    <script src="scripts/caregiver.js"></script>
    <script>
        // Sync alerts preview to overview section
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                const full = document.getElementById('missed-alerts');
                const preview = document.getElementById('alerts-preview');
                if (full && preview) {
                    const banners = full.querySelectorAll('.alert-banner');
                    const first3 = Array.from(banners).slice(0, 3);
                    preview.innerHTML = first3.map(b => b.outerHTML).join('') || '<div class="empty-state"><div class="empty-icon">‚úÖ</div><p>No missed doses!</p></div>';
                }
            }, 700);
            setInterval(() => {
                const full = document.getElementById('missed-alerts');
                const preview = document.getElementById('alerts-preview');
                if (full && preview) {
                    const banners = full.querySelectorAll('.alert-banner');
                    const first3 = Array.from(banners).slice(0, 3);
                    if (first3.length) preview.innerHTML = first3.map(b => b.outerHTML).join('');
                }
            }, 3000);
        });
    </script>
</body>

</html>